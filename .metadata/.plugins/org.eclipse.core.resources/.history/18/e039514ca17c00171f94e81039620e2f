package br.com.vaga.emprego.util;


import java.util.ArrayList;
import java.util.HashMap;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.Map;

import br.com.vaga.emprego.stream.Stream;


/**
 * Created by rnaufal on 17/11/16.
 */
public class StreamUtils {

    public static final char NOT_FOUND = ' ';

    private static final String VOGAIS_REGEX = "(?i)[a√°√†√£√¢√?√Ä√É√Çe√©√™√â√äi√≠√?o√≥√µ√¥√ì√ï√îu√∫√ö]";

    private static final String SPECIAL_CHARACTER_REGEX = "[^\\w]";

    private static final String DIGIT_REGEX = "\\d";

    private StreamUtils() {

    }

    public static char firstChar(Stream input) {
       
        Map<Character, Boolean> vogais = new LinkedHashMap<>();
        Map<Character, List<Character>> predecessors = new HashMap<>();

        char previousChar = ' ';
        while (input.hasNext()) {
            char currentChar = input.getNext();

            configuraVogais(vogais, currentChar);
            computePredecessor(predecessors, currentChar, previousChar);

            previousChar = currentChar;
        }

        return procurarVogal(vogais, predecessors);
    }

    private static Character procurarVogal(Map<Character, Boolean> vowelsByOccurrence,
                                         Map<Character, List<Character>> predecessors) {
        for (Map.Entry<Character, Boolean> vowelOccurrence : vowelsByOccurrence.entrySet()) {
            if (!vowelOccurrence.getValue()) {
                continue;
            }

            for (Character vowelPredecessor : predecessors.get(vowelOccurrence.getKey())) {
                if (!isConsonant(vowelPredecessor)) {
                    continue;
                }

                for (Character consonantPredecessor : predecessors.get(vowelPredecessor)) {
                    if (isVogal(consonantPredecessor)) {
                        return vowelOccurrence.getKey();
                    }
                }
            }
        }
        return NOT_FOUND;
    }

    private static void computePredecessor(Map<Character, List<Character>> predecessors,
                                           char currentChar,
                                           char previousChar) {
        List<Character> characters = predecessors.get(currentChar);
        if (characters == null) {
            characters = new ArrayList<>();
            predecessors.put(currentChar, characters);
        }
        if (previousChar != ' ') {
            characters.add(previousChar);
        }
    }

    private static void configuraVogais(Map<Character, Boolean> vogais,
                                                  char caractere) {
        if (!isVogal(caractere)) {
            return;
        }
        if (vogais.get(caractere) == null) {
        	vogais.put(caractere, true);
        } else {
        	vogais.put(caractere, false);
        }
    }

    private static boolean isVogal(char caractere) {
        return isVowel(String.valueOf(caractere));
    }

    private static boolean isConsonant(char vowelPredecessor) {
        String character = String.valueOf(vowelPredecessor);
        return !isVowel(character) &&
                !isSpecialCharacter(character) &&
                !isDigit(character);
    }

    private static boolean isVowel(String character) {
        return character.matches(VOGAIS_REGEX);
    }

    private static boolean isDigit(String character) {
        return character.matches(DIGIT_REGEX);
    }

    private static boolean isSpecialCharacter(String character) {
        return character.matches(SPECIAL_CHARACTER_REGEX);
    }
}
